{% extends 'base.html' %}

{% block content %}
<h1>Verkaufsliste</h1>
<style>
  table {
    border-collapse: collapse;
    width: 100%;
  }

  th, td {
    padding: 8px;
    text-align: left;
    border-bottom: 1px solid #ddd;
    cursor: pointer;
    position: relative;
  }

  tr:nth-child(even) {
    background-color: #f2f2f2;
  }

 th::after {
  content: "";
  border-style: solid;
  border-width: 0.25em 0.25em 0;
  display: inline-block;
  height: 0.5em;
  width: 0.5em;
  position: absolute;
  top: 50%;
  right: -0.25em;
  transform: translateY(-50%);
  opacity: 0.5;
}

th.asc::after {
  border-color: transparent transparent #000;
}

th.desc::after {
  border-color: #000 transparent transparent;
}

</style>

<table>
  <thead>
    <tr>
      <th>Gerät</th>
      <th>Preis</th>
      <th>Verkaufsdatum</th>
      <th>Zahlungsart</th>
      <th>Kunde</th>
      <th>RechnungsNr</th>
      <th>Verkäufer</th>
      <th>Bezahlt</th>
      <th>Zahlungsdatum</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    {% for verkauf in verkauf_list|dictsortreversed:'verkaufsdatum' %}
    <tr>
      <form action="{% url 'verkauf_liste' %}" method="post">
        {% csrf_token %}
        <td>
          {% if verkauf.waschmaschine %}
            {{ verkauf.type_of}}
          {% elif verkauf.kuhlschrank %}
            {{ verkauf.type_of}}
          {% elif verkauf.spuelmaschine %}
            {{ verkauf.type_of}}
          {% elif verkauf.herdset %}
            {{ verkauf.type_of}}
          {% elif verkauf.herdplatte %}
            {{ verkauf.type_of}}
          {% elif verkauf.standherd %}
            {{ verkauf.type_of}}
          {% elif verkauf.backofen %}
            {{ verkauf.type_of}}
          {% elif verkauf.trockner %}
            {{ verkauf.type_of}}
          {% elif verkauf.abzughaube %}
            {{ verkauf.type_of}}
          {% elif verkauf.sonst %}
            {{ verkauf.type_of}}

          {% endif %}
        </td>
        <td>{{ verkauf.final_preis }}</td>
        <td>{{ verkauf.verkaufsdatum }}</td>
        <td>{{ verkauf.zahlungsart }}</td>
        <td>{{ verkauf.kunde_name }}</td>
        <td>{{ verkauf.rechnungs_nr }}</td>
        <td>{{ verkauf.verkäufer }}</td>
        <td>
          <select name="bezahlt" onchange="confirmBezahltChange(this)">
            <option value="--">--</option>
            <option value="Ja" {% if verkauf.bezahlt == 'Ja' %}selected{% endif %}>Ja</option>
            <option value="Nein" {% if verkauf.bezahlt == 'Nein' %}selected{% endif %}>Nein</option>
          </select>
        </td>
        <td>
          <input type="date" name="zahlungsdatum" value="{{ verkauf.zahlungsdatum | date:'Y-m-d' }}" onchange="confirmZahlungsdatumChange(this)">
        </td>
        <input type="hidden" name="verkauf_id" value="{{ verkauf.id }}">
        <td><input type="submit" value="Herunterladen"></td>
        <td><a href="{% url 'admin:inventory_verkauf_change' verkauf.id %}">bearbeiten</a></td>
        <td>
          <a href="#" class="delete-link">Löschen</a>
        </td>
      </form>
    </tr>
    {% endfor %}
  </tbody>
</table>

<!-- JavaScript code to show the confirmation message -->
<script>
  const deleteLinks = document.querySelectorAll('.delete-link');
  deleteLinks.forEach(link => {
    link.addEventListener('click', (event) => {
      event.preventDefault();
      // Are you sure you want to delete this message? The selled object will be returned to your inventory.
      const confirmation = confirm("Sorry but you can not delete an invoice yet");
      if (confirmation) {
        // If user confirms, submit the form
        link.closest('form').submit();
      }
    });
  });
</script>

<!-- JavaScript code to show the warning message -->
<script>
let originalBezahltValue = '{{ verkauf.bezahlt }}';
  let originalZahlungsdatumValue = '{{ verkauf.zahlungsdatum | date:'Y-m-d' }}';

  function confirmBezahltChange(selectElement) {
    const newValue = selectElement.value;
    const confirmation = confirm(`Are you sure you want to change "Bezahlt" to "${newValue}"?`);
    if (confirmation) {
      originalBezahltValue = newValue; // Update the original value
    } else {
      selectElement.value = originalBezahltValue; // Reset the select element to the original value
    }
  }

  function confirmZahlungsdatumChange(inputElement) {
    const newValue = inputElement.value;
    const confirmation = confirm(`Are you sure you want to change "Zahlungsdatum" to "${newValue}"?`);
    if (confirmation) {
      originalZahlungsdatumValue = newValue; // Update the original value
    } else {
      inputElement.value = originalZahlungsdatumValue; // Reset the input element to the original value
    }
  }

</script>

<script>
  // Function to sort the table by the given column index
  function sortTable(columnIndex) {
    let table, rows, switching, i, x, y, shouldSwitch;
    table = document.querySelector('table');
    switching = true;

    // Get the current sorting column index and direction
    let currentSortIndex = parseInt(table.getAttribute('data-sort-index') || 0);
    let sortOrder = table.getAttribute('data-sort-order') || 'asc';

    // Determine if the user clicked on the same column
    if (columnIndex === currentSortIndex) {
      // Reverse the sorting order
      sortOrder = sortOrder === 'asc' ? 'desc' : 'asc';
    } else {
      // Set the new sorting column and default to ascending order
      currentSortIndex = columnIndex;
      sortOrder = 'asc';
    }

    // Update the sorting indicators
    const headers = document.querySelectorAll('th');
    headers.forEach((header, index) => {
      header.classList.remove('asc', 'desc');
      if (index === currentSortIndex) {
        header.classList.add(sortOrder);
      }
    });

    table.setAttribute('data-sort-index', currentSortIndex);
    table.setAttribute('data-sort-order', sortOrder);

    while (switching) {
      switching = false;
      rows = table.rows;

      for (i = 1; i < (rows.length - 1); i++) {
        shouldSwitch = false;
        x = rows[i].getElementsByTagName('td')[columnIndex];
        y = rows[i + 1].getElementsByTagName('td')[columnIndex];

        if (sortOrder === 'asc') {
          if (x.innerHTML.toLowerCase() > y.innerHTML.toLowerCase()) {
            shouldSwitch = true;
            break;
          }
        } else if (sortOrder === 'desc') {
          if (x.innerHTML.toLowerCase() < y.innerHTML.toLowerCase()) {
            shouldSwitch = true;
            break;
          }
        }
      }

      if (shouldSwitch) {
        rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
        switching = true;
      }
    }
  }

  // Attach event listeners to the table headers for sorting
  document.querySelectorAll('th').forEach((header, index) => {
    header.addEventListener('click', () => sortTable(index));
  });
</script>

{% endblock %}
